# v1.5 Implementation Plan - Experiments (RSA + Landing Pages)

## Executive Summary

**Goal**: Implement a systematic A/B testing framework for Responsive Search Ads (RSAs) and Landing Pages to improve CTR and conversion rates with minimal spend and statistical rigor.

**Timeline**: 4-6 days
**Priority**: HIGH - Continuous optimization through data-driven experiments
**Complexity**: High (statistical analysis, variant generation, measurement infrastructure)

## Core Deliverables

### 1. Experiment Registry & Management
- **experiments.json**: Central registry of all active/paused/completed tests
- **experiments.md**: Human-readable summary of what's being tested and why
- **experiment_results_<id>.json**: Statistical analysis and decisions for each test

### 2. RSA Variant Generation
- **Benefit-led vs Proof-led headlines** with similarity guards
- **Google Ads Editor CSV** with variant ads (paused by default)
- **Labels system** for tracking (EXP_BENEFIT, EXP_PROOF)

### 3. Landing Page A/B Testing
- **Content variants** with routing logic
- **Cookie-based assignment** for consistent user experience
- **Variant generators** for headlines, proof blocks, FAQs

## Technical Architecture

### Phase 1: Experiment Framework (Day 1-2)

#### Task 1.1: Experiment Manager
```typescript
// src/experiments/experiment-manager.ts
export interface Experiment {
  id: string;
  type: 'rsa' | 'landing_page';
  product: string;
  targetId: string; // ad_group_id or page_path
  variants: Variant[];
  startDate: Date;
  endDate?: Date;
  status: 'draft' | 'active' | 'paused' | 'completed';
  targetMetric: 'ctr' | 'cvr' | 'cws_click_rate';
  minimumSampleSize: number;
  confidenceLevel: number;
  guards: ExperimentGuard[];
}

export class ExperimentManager {
  // Experiment lifecycle
  async createExperiment(config: ExperimentConfig): Promise<Experiment>
  async startExperiment(experimentId: string): Promise<void>
  async pauseExperiment(experimentId: string): Promise<void>
  async completeExperiment(experimentId: string, winner: string): Promise<void>
  
  // Validation
  validateExperiment(experiment: Experiment): ValidationResult
  checkGuards(experiment: Experiment): GuardResult[]
}
```

#### Task 1.2: Variant Generator
```typescript
// src/experiments/variant-generator.ts
export class RSAVariantGenerator {
  private embeddingService: EmbeddingService;
  
  // Generate RSA variants
  async generateRSAVariants(
    adGroup: AdGroup,
    strategies: VariantStrategy[]
  ): Promise<RSAVariant[]>
  
  // Similarity check to prevent near-duplicates
  async checkSimilarity(variant1: RSAVariant, variant2: RSAVariant): Promise<number>
  
  // Guards
  ensureUniqueness(variants: RSAVariant[], threshold = 0.9): RSAVariant[]
  validateClaims(variant: RSAVariant, product: string): boolean
}

export class LandingPageVariantGenerator {
  // Generate page variants
  async generatePageVariants(
    basePage: PageContent,
    strategy: 'headline' | 'proof_block' | 'faq_order' | 'social_proof'
  ): Promise<PageVariant[]>
  
  // Content blocks
  generateHeadlineVariant(original: string): string
  generateProofBlock(useCase: string): ProofBlock
  reorderFAQs(faqs: FAQ[], strategy: 'importance' | 'engagement'): FAQ[]
}
```

### Phase 2: Statistical Analysis Engine (Day 2)

#### Task 2.1: Statistical Tests
```typescript
// src/experiments/statistics.ts
export class StatisticalAnalyzer {
  // Two-proportion z-test for CTR
  twoProportionTest(
    control: { clicks: number; impressions: number },
    variant: { clicks: number; impressions: number },
    confidenceLevel: number
  ): {
    pValue: number;
    significant: boolean;
    uplift: number;
    confidenceInterval: [number, number];
  }
  
  // Bayesian A/B testing with Beta distribution
  bayesianAB(
    control: MetricData,
    variant: MetricData
  ): {
    probabilityVariantBetter: number;
    expectedLift: number;
    credibleInterval: [number, number];
  }
  
  // Sample size calculator
  calculateSampleSize(
    baselineRate: number,
    minimumDetectableEffect: number,
    power: number,
    significance: number
  ): number
  
  // Early stopping rules
  shouldStopEarly(experiment: Experiment, results: ExperimentResults): {
    stop: boolean;
    reason?: 'futility' | 'success' | 'harm';
  }
}
```

#### Task 2.2: Power Analysis
```typescript
// src/experiments/power-analysis.ts
export class PowerAnalyzer {
  // Pre-experiment power analysis
  async planExperiment(
    historicalData: HistoricalMetrics,
    desiredLift: number,
    confidenceLevel: number
  ): ExperimentPlan
  
  // Runtime power check
  checkStatisticalPower(
    currentResults: ExperimentResults
  ): {
    currentPower: number;
    samplesNeeded: number;
    estimatedDaysRemaining: number;
  }
}
```

### Phase 3: Measurement Infrastructure (Day 3)

#### Task 3.1: Data Collection
```typescript
// src/experiments/measurement.ts
export class ExperimentMeasurement {
  // Collect RSA performance
  async collectRSAMetrics(
    experimentId: string,
    dateRange: DateRange
  ): Promise<RSAMetrics[]>
  
  // Collect landing page metrics
  async collectPageMetrics(
    experimentId: string,
    dateRange: DateRange
  ): Promise<PageMetrics[]>
  
  // Join with conversion data
  async enrichWithConversions(
    metrics: BaseMetrics[],
    conversionEvents: ConversionEvent[]
  ): EnrichedMetrics[]
  
  // ValueTrack parameter mapping
  mapValueTrackToVariant(valueTrackParams: ValueTrackParams): string
}
```

#### Task 3.2: Attribution
```typescript
// src/experiments/attribution.ts
export class ExperimentAttribution {
  // Cookie-based assignment for LP tests
  assignUserToVariant(
    experimentId: string,
    userId?: string
  ): {
    variant: string;
    assignmentId: string;
    expiresAt: Date;
  }
  
  // Track variant exposure
  recordExposure(
    experimentId: string,
    variant: string,
    timestamp: Date
  ): void
  
  // Link conversions to variants
  attributeConversion(
    conversionEvent: ConversionEvent,
    lookbackWindow: number
  ): AttributedConversion
}
```

### Phase 4: Database Schema (Day 3-4)

#### Task 4.1: Experiment Tables
```sql
-- Experiment registry
CREATE TABLE fact_ab_tests (
  test_id TEXT PRIMARY KEY,
  type TEXT CHECK(type IN ('rsa', 'landing_page')),
  product TEXT,
  ad_group_id TEXT,
  page_id TEXT,
  start_at TIMESTAMP,
  end_at TIMESTAMP,
  status TEXT,
  target_metric TEXT,
  min_sample_size INTEGER,
  confidence_level REAL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Variant definitions
CREATE TABLE fact_ab_variants (
  test_id TEXT,
  variant_id TEXT,
  variant_name TEXT,
  label TEXT,
  copy_hash TEXT,
  headlines JSON,
  descriptions JSON,
  lp_path TEXT,
  is_control BOOLEAN DEFAULT FALSE,
  PRIMARY KEY (test_id, variant_id),
  FOREIGN KEY (test_id) REFERENCES fact_ab_tests(test_id)
);

-- Metrics collection
CREATE TABLE fact_ab_metrics (
  date DATE,
  test_id TEXT,
  variant_id TEXT,
  impressions INTEGER,
  clicks INTEGER,
  cost REAL,
  conversions INTEGER,
  cws_clicks INTEGER,
  bounce_rate REAL,
  PRIMARY KEY (date, test_id, variant_id),
  FOREIGN KEY (test_id, variant_id) REFERENCES fact_ab_variants(test_id, variant_id)
);

-- Statistical results
CREATE TABLE fact_ab_results (
  test_id TEXT,
  analysis_date TIMESTAMP,
  control_variant TEXT,
  test_variant TEXT,
  metric TEXT,
  control_value REAL,
  test_value REAL,
  uplift REAL,
  p_value REAL,
  confidence_lower REAL,
  confidence_upper REAL,
  sample_size_control INTEGER,
  sample_size_test INTEGER,
  decision TEXT,
  PRIMARY KEY (test_id, analysis_date, metric)
);
```

### Phase 5: Export Writers (Day 4)

#### Task 5.1: RSA Export
```typescript
// src/writers/rsa-experiment-writer.ts
export class RSAExperimentWriter {
  // Generate Google Ads Editor CSV
  generateEditorCSV(
    experiment: Experiment,
    variants: RSAVariant[]
  ): {
    ads: string; // Paused RSA variants with labels
    labels: string; // Experiment tracking labels
  }
  
  // Generate API mutations
  generateAPIMutations(
    experiment: Experiment,
    variants: RSAVariant[]
  ): GoogleAdsMutation[]
}
```

#### Task 5.2: Landing Page Export
```typescript
// src/writers/lp-experiment-writer.ts
export class LandingPageExperimentWriter {
  // Generate variant content files
  generateVariantFiles(
    experiment: Experiment,
    variants: PageVariant[]
  ): {
    variantA: string; // Control content
    variantB: string; // Test content
    routing: string; // Routing logic/config
  }
  
  // Generate A/B test configuration
  generateTestConfig(experiment: Experiment): ABTestConfig
}
```

### Phase 6: CLI Commands (Day 5)

#### Task 6.1: Experiment CLI
```typescript
// src/cli-experiments.ts
program
  .command('start-experiment')
  .description('Start a new A/B test')
  .option('--type <type>', 'rsa or lp')
  .option('--product <product>', 'Product name')
  .option('--ad-group <name>', 'Ad group for RSA test')
  .option('--page <path>', 'Page path for LP test')
  .option('--variants <list>', 'Comma-separated variant strategies')
  .option('--min-samples <n>', 'Minimum sample size per variant')
  .action(startExperimentCommand);

program
  .command('analyze-experiment')
  .description('Analyze experiment results')
  .option('--test-id <id>', 'Experiment ID')
  .option('--min-clicks <n>', 'Minimum clicks before analysis')
  .action(analyzeExperimentCommand);

program
  .command('stop-experiment')
  .description('Stop an experiment and apply decision')
  .option('--test-id <id>', 'Experiment ID')
  .option('--accept <variant>', 'winner|control|variant_id')
  .action(stopExperimentCommand);

program
  .command('list-experiments')
  .description('List all experiments')
  .option('--status <status>', 'Filter by status')
  .option('--product <product>', 'Filter by product')
  .action(listExperimentsCommand);
```

### Phase 7: Monitoring & Reporting (Day 5-6)

#### Task 7.1: Experiment Dashboard
```typescript
// src/monitors/experiment-monitor.ts
export class ExperimentMonitor {
  // Real-time experiment status
  async getExperimentStatus(
    experimentId: string
  ): ExperimentStatus
  
  // Health checks
  checkExperimentHealth(experiment: Experiment): {
    healthy: boolean;
    issues: string[];
  }
  
  // Alerts
  checkAlertConditions(experiment: Experiment): Alert[]
}
```

#### Task 7.2: Reports
```typescript
// src/writers/experiment-report-writer.ts
export class ExperimentReportWriter {
  // Human-readable summary
  generateSummaryMD(
    experiment: Experiment,
    results: ExperimentResults
  ): string
  
  // Detailed statistical report
  generateStatisticalReport(
    experiment: Experiment,
    analysis: StatisticalAnalysis
  ): string
  
  // Executive summary
  generateExecutiveSummary(
    experiments: Experiment[]
  ): string
}
```

## Testing Strategy

### Unit Tests
- Variant generation with similarity checks
- Statistical calculations
- Sample size determination
- Attribution logic

### Integration Tests
- End-to-end experiment creation
- Data collection pipeline
- Export generation
- Decision application

### Statistical Tests
- Power analysis validation
- Type I/II error rates
- Confidence interval coverage

## Risk Mitigation

### Technical Risks
1. **Low Traffic**: Pool experiments, use Bayesian methods with informative priors
2. **Variant Pollution**: Strict similarity thresholds, manual review
3. **Data Quality**: Validation checks, outlier detection

### Business Risks
1. **Poor Variants**: Claims validation, brand guidelines check
2. **Negative Impact**: Early stopping rules, harm detection
3. **Test Fatigue**: Limit concurrent tests, prioritize high-impact

## Success Metrics

### Immediate (Week 1)
- 3+ experiments launched
- All variants pass similarity checks
- Measurement pipeline operational

### Month 1
- 5+ completed experiments
- Average CTR lift of 10%
- 2+ winning variants deployed

### Quarter 1
- 20+ experiments completed
- 20% overall CTR improvement
- 15% CVR improvement

## Implementation Schedule

### Day 1: Framework Foundation
- [ ] Morning: Experiment manager core
- [ ] Afternoon: Variant generators (RSA)
- [ ] Evening: Database schema

### Day 2: Statistical Engine
- [ ] Morning: Statistical tests implementation
- [ ] Afternoon: Power analysis
- [ ] Evening: Unit tests for statistics

### Day 3: Measurement
- [ ] Morning: Data collection pipeline
- [ ] Afternoon: Attribution system
- [ ] Evening: Integration with GA4

### Day 4: Exports & CLI
- [ ] Morning: RSA export writer
- [ ] Afternoon: Landing page variants
- [ ] Evening: CLI commands

### Day 5: Polish & Testing
- [ ] Morning: Monitoring system
- [ ] Afternoon: Report generators
- [ ] Evening: End-to-end testing

### Day 6: Documentation & Launch
- [ ] Morning: User documentation
- [ ] Afternoon: Statistical methodology docs
- [ ] Evening: Launch prep

## Dependencies

### External
- Google Ads API (ad performance)
- GA4/Plausible (conversion tracking)
- OpenAI API (embeddings for similarity)

### Internal
- Existing mutation validation
- Landing page health checker
- Cache infrastructure

## Documentation Requirements

1. **User Guide**: How to design and run experiments
2. **Statistical Guide**: Methodology and interpretation
3. **Best Practices**: Variant design, test duration
4. **API Reference**: New CLI commands

## Rollout Plan

### Week 1: Pilot
- Single RSA experiment on ConvertMyFile
- Manual monitoring
- Daily results review

### Week 2: Expansion
- Add landing page experiments
- Enable for all products
- Automated daily reports

### Month 1: Scale
- Multiple concurrent experiments
- Automated winner deployment
- Cross-product learnings

## Future Enhancements

1. **Multi-Armed Bandits**: Dynamic traffic allocation
2. **Multivariate Testing**: Test multiple elements simultaneously
3. **Personalization**: User segment-specific variants
4. **ML-Driven Variants**: AI-generated test hypotheses
5. **Cross-Channel Testing**: Coordinate SEO/SEM experiments

---

**Estimated Effort**: 4-6 days
**Complexity**: High
**ROI**: High (compounding CTR/CVR improvements)
**Risk**: Medium (requires careful statistical design)