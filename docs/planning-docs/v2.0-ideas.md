# v2.0 — Optimizer + MCP + One-Click Ops (Guardrailed)

## 0) Scope & outcomes

Objective: turn the system into a safe optimizer: propose daily budgets/bids/creatives, expose everything via MCP, and require explicit human approval to apply.

You’ll ship:
	•	A budget allocator (bandit-style) producing daily proposals.
	•	A bid strategy advisor (when to move to tCPA/tROAS; rollback logic).
	•	A creative rotation policy (promote/pause RSA variants).
	•	An MCP server exposing your core tools.
	•	Optional PM integration (ClickUp task push).

⸻

## 1) Artifacts

plans/_optimizer/<date>/
  budget_proposals.json       # per campaign/ad group/market
  bid_advisor.md              # recs + gates/volume checks
  creative_rotation.json      # pause/promote lists + justifications
  apply_diff.json             # what would change if applied (dry-run)
  optimizer_audit.log         # decisions, guards hit, runtime
  
  budget_proposals.json (contract)
  
  {
  "generated_at": "2025-09-12",
  "objective": "maximize_CWS_Clicks",
  "constraints": {"daily_cap_AUD": 40, "min_per_campaign": 2, "max_change_pct": 25},
  "proposals": [
    {"engine":"google","campaign":"PK_Search_AU","current":10,"proposed":12.5,"reason":"UCB↑ CTR & CWS"},
    {"engine":"microsoft","campaign":"CMF_Search_US","current":8,"proposed":6.0,"reason":"low UCB; CPC↑"}
  ]
}

creative_rotation.json

{
  "promote":[{"ad_group":"WebP PNG AU","ad_id":"rsa_123","why":"CTR +28% vs control"}],
  "pause":[{"ad_group":"Color Picker US","ad_id":"rsa_987","why":"CWS_Click rate -35%, n=400"}],
  "new_variants":[{"ad_group":"WebP PNG AU","variants":["benefit","proof"]}]
}

## 2) Optimizer logic (plain English + formulas)

### A) Budget allocator (per campaign/ad group)
	•	Arms: ad groups (or campaigns) × markets × engines.
	•	Reward: smoothed CWS_Clicks per $ (or First-Run per $ when available).
	•	Model: UCB1 or Thompson Sampling with exploration floor (e.g., ≥10% budget spread).
	•	Cold start: initialize with prior from cluster intent weight and QS.
	•	Constraints:
	•	Per-product and per-market daily caps.
	•	Max delta per day (e.g., ±25%).
	•	Exclude entities failing url_health or with QS ≤ 3 (until triaged).

UCB sketch:

score = mean_reward + alpha * sqrt( (2 * ln T) / n )
proposed_budget ∝ score, then normalized under caps & max_change_pct

### B) Bid strategy advisor
	•	Switch to Maximize conversions / tCPA only if:
	•	≥30 conversions in last 30 days per campaign, stable tracking, CPA within target band.
	•	Rollback to Manual CPC if CPA inflates ≥40% for 7 consecutive days or conversions drop ≥50%.
	•	Provide exact GAQL checks + “why not eligible yet” reasons.

### C) Creative rotation policy
	•	Promote a variant if CTR and CWS_Click rate beats control by ≥20% with n≥300 clicks.
	•	Pause a variant if underperforms by ≥25% with n≥300 or over 14 days.
	•	Always keep one control ad; new variants start paused.

⸻

## 3) MCP surfaces (minimal, safe)

Expose thin tools; each returns artifact paths and a 10-line digest.
	•	plan(product, markets, options)
	•	optimize_budget(objective, caps) → budget_proposals.json
	•	bid_advice(product) → bid_advisor.md
	•	rotate_creatives(product) → creative_rotation.json
	•	dry_run_apply(artifact) → apply_diff.json
	•	apply(artifact, confirm=true) → executes Ads API changes (guarded)
	•	ingest_search_terms(...), propose_negatives(...), start_experiment(...) (from earlier versions)

Guardrails in MCP
	•	Hard refuse apply if:
	•	Any targeted LP fails url_health,
	•	Claims validation fails,
	•	Proposed change > max_change_pct,
	•	Budget would exceed daily cap.

⸻

## 4) CLI (mirrors MCP)

seo-ads optimize-budget --objective cws --caps daily=40,per_campaign_min=2 --dry-run
seo-ads bid-advice --product palettekit
seo-ads rotate-creatives --product convertmyfile --dry-run
seo-ads apply --artifact plans/_optimizer/2025-09-12/budget_proposals.json --confirm

## 5) DB additions

CREATE TABLE fact_channel_spend (
  date TEXT, engine TEXT, campaign_id TEXT, ad_group_id TEXT,
  clicks INT, impressions INT, cost NUMERIC, cws_clicks INT, first_runs INT,
  PRIMARY KEY (date, engine, campaign_id, ad_group_id)
);
CREATE TABLE optimizer_proposals (
  run_id TEXT, generated_at TEXT, type TEXT, payload_json TEXT, applied INT DEFAULT 0,
  PRIMARY KEY (run_id, type)
);

## 6) Guardrails & safety
	•	Dry-run first always; output apply_diff.json with exact GAQL operations or Editor CSV deltas.
	•	Change caps: ±25% per entity/day default; configurable per product.
	•	QS/Health gates: block optimizer on QS ≤3 or LP failing health.
	•	Audit log: every apply writes an immutable line to optimizer_audit.log with who/when/what.

⸻

## 7) Testing
	•	Sim harness: synthetic datasets with known “best” arms; assert allocator converges within N days.
	•	Safety tests: propose budgets hitting caps; verify guard refusal.
	•	Rollback tests: simulate CPA spike; ensure bid advisor recommends revert.
	•	Idempotency: running apply twice should no-op.

⸻

## 8) Acceptance gates
	•	Budget proposals respect caps and produce sensible reallocation (no starve/overfund).
	•	Bid advisor outputs clear “eligible / not yet (why)” per campaign with hard numbers.
	•	Creative rotation lists promote/pause/new with n and deltas; exports import cleanly.
	•	MCP round-trip: call → artifact → dry-run → human confirm → apply → audit.

⸻

## 9) Effort & risks
	•	Effort: 7–12 days.
	•	Risks: low data → noisy optimization. Mitigate with exploration floor, priors, and strict caps; never auto-apply without human confirm.