Perfect—here’s a tight, build-ready map for v1.7: Alerts, SERP Drift & Guardrails Everywhere. No heavy code, just clear contracts, thresholds, and tasks so you can ship fast.

⸻

# 0) Scope & outcomes

Objective: detect meaningful problems/opportunities early and generate ready-to-run remedies (dry-run by default).

You’ll ship:
	•	A small detector engine (CTR/QS/spend/CPC/conv-rate anomalies, SERP drift, LP regressions).
	•	A single alerts artifact per run (alerts.json) + concise console table.
	•	A playbooks module that turns an alert into a remediation plan (CLI-executable, dry-run).
	•	Guardrails: never apply if LP fails health, never exceed budget caps, always allow review.

⸻

# 1) Data you already have (and will reuse)
	•	fact_search_terms (clicks, impressions, cost, conversions)
	•	fact_qs (expected CTR, ad relevance, LP experience, QS)
	•	fact_serp_snapshot (features: ai_overview/shopping/video + top domains)
	•	fact_url_health (status, noindex, soft-404, redirects, canonical_ok)
	•	(optional) GA4/Plausible funnel events (CWS_Click → proxy conversion)

New lightweight tables

CREATE TABLE alerts_state (
  alert_id TEXT PRIMARY KEY,         -- deterministic hash (type+entity+window)
  status TEXT NOT NULL,              -- open|ack|snoozed|closed
  first_seen TEXT NOT NULL,
  last_seen TEXT NOT NULL,
  snooze_until TEXT,                 -- optional
  notes TEXT
);

CREATE TABLE alerts_history (
  seen_at TEXT NOT NULL,
  alert_id TEXT NOT NULL,
  payload_json TEXT NOT NULL
);

# 2) Alert types, signals & thresholds (pragmatic defaults)

Use two windows: baseline=last 14d vs current=last 1–3d (configurable). Require min volume to avoid noise.

A) Spend Spike / Drop (per campaign/ad group)
	•	Metrics: spend/day.
	•	Fire if: current >= max(baseline*1.5, baseline+ A$10) and clicks_current ≥ 50 (spike)
or current ≤ baseline*0.5 (drop with sufficient impressions).
	•	Severity: proportional to absolute $ delta.

B) CTR Drop (per ad group or keyword cluster)
	•	Metrics: CTR, impressions.
	•	Fire if: CTR_current / CTR_baseline ≤ 0.7 and impr_current ≥ 1000.

C) CPC Jump (efficiency)
	•	Metrics: CPC.
	•	Fire if: CPC_current / CPC_baseline ≥ 1.3 and clicks_current ≥ 100.

D) Conversion-rate Drop (CWS_Click rate)
	•	Metrics: CWS_Click / sessions (or per click if you prefer).
	•	Fire if: rate_current / rate_baseline ≤ 0.7 and sessions_current ≥ 300.

E) Quality Score Triage (per ad group)
	•	Fire if: QS ≤ 4 or component downgraded (Expected CTR / Ad Relevance / LP Experience == “Below average”).
	•	Attach component deltas to alert.

F) SERP Drift (per cluster/market)
	•	Compare last two fact_serp_snapshots.
	•	Fire on presence change of AI Overview / Shopping / Video pack or new top-3 domain.
	•	Severity: AI Overview + Shopping = High; single feature toggle = Medium.

G) LP Regression (per URL)
	•	Fire on transitions: 200→4xx/5xx, noindex=1, soft_404=1, canonical loops, redirect chain >1.
	•	Always Critical (blocks apply).

Noise control
	•	Require condition to hold for 2 consecutive checks OR set cooldown (e.g., don’t re-alert for 24h once acked).
	•	Use hysteresis (trigger at 30% drop, clear only when recovered to 90% of baseline).

⸻

# 3) Alert object & artifact

File: plans/<product>/<date>/alerts.json

{
  "generated_at": "2025-09-08T03:00:00Z",
  "summary": { "open": 5, "critical": 2, "high": 2, "medium": 1 },
  "alerts": [
    {
      "id": "ctr_drop:adgroup:palettekit:web_color_picker:AU",
      "type": "ctr_drop",
      "severity": "high",
      "entity": { "engine": "google", "campaign": "PaletteKit_Search_AU", "ad_group": "Web Color Picker" },
      "window": { "baseline_days": 14, "current_days": 3 },
      "metrics": { "ctr_current": 0.021, "ctr_baseline": 0.034, "impr": 12450 },
      "why": "CTR fell 38% on sufficient volume.",
      "playbook": "pb_ctr_drop",
      "suggested_actions": [
        { "action": "generate_rsa_variants", "variants": ["benefit", "proof"], "dry_run": true },
        { "action": "add_sitelinks", "items": ["Palette Generator","Contrast Checker"], "dry_run": true }
      ]
    }
  ]
}

Console summary (example)

ALERTS (AU/US/GB)  5 open  (2 critical, 2 high, 1 medium)
! CRITICAL  LP_REGRESSION  /convertmyfile/heic-to-jpg  200→noindex  (blocks apply)
! HIGH      CTR_DROP       AdGroup Web Color Picker AU  -38% vs 14d  (12.4k impr)
  HIGH      SERP_DRIFT     Cluster "webp to png" US     AI Overview appeared
  MEDIUM    CPC_JUMP       Campaign NoteBridge_US       +42% CPC on 380 clicks
  
# 4) Playbooks (deterministic remediations)

Map alert.type → playbook id → steps. Always support --dry-run.

pb_lp_regression
	1.	Block applies to affected LPs.
	2.	Output fix list (remove noindex, resolve 4xx/redirects, add H1).
	3.	Re-run url_health on demand: seo-ads validate-only --url <...>.

pb_ctr_drop
	1.	Inspect QS components.
	2.	If Ad Relevance/Expected CTR below avg → generate RSA variants (add primary KW to headline 1 or 2, change proof line).
	3.	Add/refresh assets: sitelinks/callouts/structured snippets from your cluster.
	4.	Optionally down-bid −10% if CPC is rising (guard: keep within min/max).

pb_cpc_jump
	1.	Surface waste n-grams contributing to CPC; propose negatives.
	2.	Consider bid cap reduction −10% (guard: spend threshold).
	3.	Review competitor density (SERP snapshot); suggest content move if Shopping/Video dominant.

pb_serp_drift
	1.	If AI Overview appeared: suggest FAQ block, FAQPage schema, potentially lower bids on generic head terms; keep exact intent terms.
	2.	If Shopping pack appeared: suggest content pivot or narrower keywords.
	3.	If new top-3 domain: extract content angle and propose LP brief tweak.

pb_qs_triage
	•	If LP experience below avg: run url_health diffs, propose on-page fixes (content depth, internal links).
	•	If Ad relevance below avg: tighten KW ↔ ad group ↔ LP mapping; suggest moving KWs or splitting groups.

CLI

seo-ads check --product all --window 14d:3d
seo-ads remedy --alert-id <id> --dry-run
seo-ads remedy --alert-id <id> --apply   # still respects guardrails
seo-ads alerts --list --status open|ack|snoozed
seo-ads alerts --ack <id> | --snooze <id> --until 2025-09-15
seo-ads alerts --simulate ctr_drop --entity "AdGroup:PaletteKit AU" --factor 0.6

# 5) Algorithms (plain English + tiny pseudo)

Baselines: compute per entity (campaign/ad group/cluster×market) using the last 14d; exclude the current window; use winsorized mean to handle outliers.

Anomaly score (z-ish):

Map to severity: score ≥2.5 → High; ≥1.5 → Medium; with critical overrides for LP regressions.

Dedup & hysteresis:
	•	alert_id = hash(type, entity, window_key)
	•	If an alert exists and status in (ack,snoozed) and within cooldown → don’t open a new one; update last_seen only.

⸻

# 6) Integration & guardrails
	•	Guardrails always on: refuse --apply if any targeted LP fails url_health or claims_validation; enforce budget caps; desktop-first by default.
	•	Artifacts first: Even remedies write exports (Editor CSV / Ads Script) by default; Ads API path stays opt-in.
	•	Runtime budgets: cap the whole seo-ads check run to ≤60s warm cache; log per-detector timings.

⸻

# 7) Testing (fast & meaningful)
	•	Unit: each detector gets a fixture (baseline/current) and expected alert/no-alert outcomes (threshold & hysteresis).
	•	Golden alerts: byte-snapshot a small alerts.json for regression.
	•	Simulation: seo-ads alerts --simulate … generates synthetic anomalies to verify end-to-end (detector → playbook → exports).
	•	Manual: flip noindex on a staging LP and confirm a Critical LP regression alert blocks apply.

⸻

# 8) Effort, risks, mitigations
	•	Effort: 2–4 days.
	•	Risks: noisy alerts → fix with min-volume gates, hysteresis, and per-type thresholds.
False confidence on conv-rate with small n → require min sessions/clicks.
	•	Mitigation: start with High/ Critical only; add Medium after a week; ship --snooze/--ack.

⸻

# 9) Done = these acceptance gates pass
	•	Running seo-ads check produces alerts.json and a readable console summary.
	•	Triggered LP regression blocks any apply; playbook points to exact fixes.
	•	CTR drop alert yields a remediation plan that produces valid RSA variant exports (paused) + assets.
	•	SERP drift alert shows an explicit feature change and a content/bid suggestion.
	•	Snooze/Ack works; no duplicate spam during cooldown.
