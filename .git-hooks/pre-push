#!/usr/bin/env bash
# Pre-push hook for feature-branch workflow
# Blocks direct pushes to main branch (use feature branches + PRs)

set -euo pipefail

# Get current branch
current_branch=$(git rev-parse --abbrev-ref HEAD)

# Block pushes to main branch
if [ "$current_branch" = "main" ]; then
  echo ""
  echo "‚ùå Direct pushes to main branch are not allowed"
  echo "   Use feature branches for development:"
  echo ""
  echo "   git checkout -b feature/your-feature-name"
  echo "   # ... make changes ..."
  echo "   git push origin feature/your-feature-name"
  echo "   # ... create PR on GitHub ..."
  echo ""
  exit 1
fi

# Allow feature/fix/chore branches
if [[ "$current_branch" =~ ^(feature|fix|chore)/ ]]; then
  # Run verify.sh if it exists (Phase 2 projects)
  if [ -f "scripts/phase-2/verify.sh" ]; then
    echo "üîç Running Phase 2 verification..."
    bash scripts/phase-2/verify.sh || exit 1
  fi

  echo "‚úÖ Pushing $current_branch..."
  exit 0
fi

# Block all other branch names
echo ""
echo "‚ùå Invalid branch name: $current_branch"
echo "   Only feature/fix/chore branches are allowed:"
echo ""
echo "   feature/  - New features"
echo "   fix/      - Bug fixes"
echo "   chore/    - Maintenance tasks"
echo ""
exit 1
